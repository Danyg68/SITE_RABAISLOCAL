# üöÄ Claude Code Rules for RabaisLocal
# R√®gles de codage et standards pour le projet RabaisLocal
# Fichier lu automatiquement par Claude Code dans VS Code

## üìã CONTEXTE DU PROJET

project_name = "RabaisLocal"
project_type = "Plateforme d'√©conomie locale intelligente"
founder = "Dany Gosselin"
launch_date = "19 mars 2026"
region = "Qu√©bec, Canada"
repository = "GitHub (rabaislocal)"

## üèóÔ∏è STACK TECHNOLOGIQUE

### Backend & Base de donn√©es
- Database: Supabase (PostgreSQL)
- Authentification: Supabase Auth
- Backend APIs: Edge Functions Supabase
- Automatisations: Make (ex-Integromat)

### Frontend & CMS
- Frontend principal: Webflow / ClickFunnels 2.0
- Admin dashboard: Retool
- Design & visuels: Figma / Canva

### Services externes
- Affiliation: GoAffPro
- Paiements: Payments.AI + PayPal
- IA: OpenAI (GPT-4o-mini)
- Design generation: Canva API + HeyGen
- Emails: MailerSend
- Notifications: OneSignal + Make
- Analytics: Metabase + Posthog + Google Analytics 4

### Hosting
- Cloud: Supabase Cloud (Canada)
- Frontend: Vercel / Webflow
- Version control: GitHub

## üìö MODULES PRINCIPAUX (A ‚Üí M)

A. Utilisateurs & Authentification
B. Syst√®me de Cr√©dits & Portefeuille
C. Commer√ßants
D. Consommateurs
E. Affili√©s (Programme 2.0)
F. Intelligence Artificielle (3 agents)
G. Administrateur (Retool)
H. L√©gal & Conformit√© (Loi 25)
I. Marketing & Communication
J. Analytics & Performance
K. S√©curit√© & Infrastructure
L. Gestion de Contenu (CMS)
M. Expansion Future

## ‚úçÔ∏è STANDARDS DE CODE

### Langue
- Tous les commentaires: FRAN√áAIS
- Toutes les variables: FRAN√áAIS (sauf conventions API)
- Noms de fonctions: fran√ßais_avec_underscores
- Exemples: "creer_utilisateur", "valider_paiement", "generer_qr_code"

### Format & Compl√©tude
- Code COMPLET, jamais d'extraits ou de pseudo-code
- Fonctionnalit√© 100% testable et d√©ployable
- Commentaires clairs et d√©taill√©s
- Gestion d'erreurs obligatoire
- Logging et audit trace requis

### Structure
- Responsive mobile-first
- Accessible (WCAG AA minimum)
- Performance optimis√©e (< 3s latence API)
- Scalable (compatible mont√©e en charge 1000+ req/min)

### JSON/API
- Format: JSON valide, pas de trailing commas
- Indentation: 2 espaces
- Nommage: camelCase pour les cl√©s
- Validation: sch√©ma clair fourni

### SQL (Supabase)
- Format: PostgreSQL standard
- Indentation: 2 espaces
- Commentaires: -- en fran√ßais
- RLS (Row Level Security) obligatoire sur tables sensibles
- Indexes sur colonnes critiques (email, dates)

### JavaScript/TypeScript
- Format: ESLint standard
- Indentation: 2 espaces
- Const par d√©faut, let si mutation n√©cessaire
- Arrow functions pr√©f√©r√©es
- Async/await pour promesses

### Make (Automatisations)
- Idempotence: obligatoire sur paiements/r√©servations
- Signature HMAC: v√©rifi√©e sur webhooks externes
- Logs: export√©s quotidiennement en CSV
- Erreurs: catch√©es et logu√©es, pas de timeout silencieux
- Payload: JSON structur√© avec sch√©ma clair

## üîí S√âCURIT√â & CONFORMIT√â

### Standards de s√©curit√©
- HTTPS/TLS 1.2+ obligatoire partout
- Chiffrement au repos (Supabase)
- Chiffrement en transit (TLS)
- RLS (Row Level Security) Supabase activ√© par d√©faut
- JWT Bearer tokens pour authentification
- X-API-Key pour services internes

### Authentification & Autorisation
- Supabase Auth (email + Google + Facebook + Apple)
- R√¥les: consumer, merchant, affiliate, admin, support, comptable
- RLS par r√¥le : chaque utilisateur ne voit que ses donn√©es
- 2FA optionnel pour affili√©s et commer√ßants

### Webhooks & API
- X-API-Key en header pour services Make
- Signature HMAC-SHA256 (header X-Signature)
- IP allowlist (Payments.AI, PayPal, GoAffPro)
- Idempotency-Key (UUID v4) sur op√©rations financi√®res
- Timeout: 30s max, gestion des retries

### Conformit√© l√©gale
- Loi 25 (Qu√©bec) obligatoire
- RGPD compatible (si expansion EU)
- OWASP Top 10 mitigu√©
- CGU, Politique de confidentialit√©, Mentions l√©gales
- Consentements tra√ßables (consent_log)
- Export donn√©es utilisateur possible (ZIP/JSON)
- Anonymisation apr√®s 24 mois inactivit√©
- TPS/TVQ collect√©es et rapport√©es

### Audits & Logs
- Tous les changements critiques logg√©s (logs_audit)
- Logs incluent : user_id, action, timestamp, IP, d√©tails
- Sauvegardes quotidiennes (7 jours glissants)
- Tests restauration mensuels document√©s
- Pentest annuel (interne + externe)

## üí∞ MOD√àLE FINANCIER

### Pricing (INCHANG√â)

#### Consommateurs
- Bronze: 9.95 $/mois
- Argent: 14.95 $/mois
- Or: 24.95 $/mois

#### Commer√ßants
- Gratuit: 0 $ (2 promos/mois)
- Bronze: 147 $ (3 mois, 50 promos/mois)
- Argent: 247 $ (3 mois, 85 promos/mois)
- Or: 397 $ (3 mois, illimit√©)

#### Affili√©s
- Trousse Promo 750: 47 $
- Trousse Promo: 77 $
- Trousse Normale: 147 $
- Renouvellement annuel: 47 $
- Frais mensuels: 27 $/mois (pr√©lev√©s automatiquement)

### Principes financiers
- Z√©ro commission commer√ßants (100% des revenus conserv√©s)
- Commission model affili√©s: GoAffPro g√©r√© (15 niveaux max)
- Double portefeuille affili√©s: Compte Principal + Compte RabaisLocal
- Retenue 27 $/mois depuis commissions
- Renouvellement 47 $ annuel (sur Compte RabaisLocal uniquement)
- TPS (5%) + TVQ (9.975%) collect√©es automatiquement
- 3% des revenus redistribu√©s √† la communaut√© (future fondation)

### Paiements
- Processeurs: Payments.AI + PayPal prioritaires
- Cryptage: HMAC-SHA256 signatures
- Idempotence: bloqu√©e via Idempotency-Key
- Rapports: TPS/TVQ export√©s mensuellement (Google Sheets)
- Conservation: 7 ans (obligations fiscales)

## üß† R√àGLES MAKE (CRITIQUES)

### Webhooks entrants
- Format: JSON structur√©
- Validation: sch√©ma d√©fini avant traitement
- Signature HMAC: v√©rifi√©e (X-Signature header)
- Idempotency: bloquer les doublons via Idempotency-Key
- Logs: ex√©cution compl√®te + erreurs + timestamps

### Sc√©narios principaux
- Webhook_Signup ‚Üí Supabase + GoAffPro + Email
- Webhook_Payment ‚Üí Supabase cr√©dits + audit
- Webhook_Commission ‚Üí Sync GoAffPro ‚Üî Supabase
- Webhook_IA_Request ‚Üí OpenAI + Supabase ai_logs
- Paiement_Mensuel_Check ‚Üí Retrait 27 $ affili√©s
- Renewal_Check_Annual ‚Üí Pr√©l√®vement 47 $ annuel

### Gestion d'erreurs Make
- Retry: max 3 tentatives (exponential backoff)
- Timeout: 30s max
- Error logging: toujours enregistrer l'erreur
- Fallback: notification admin si √©chec apr√®s retries
- Idempotence: v√©rifier avant de rejouer

### Performance Make
- Temps de r√©ponse API: < 3s cible
- Parallelisation: activ√©e si possible (multi-routeurs)
- Rate limiting: respecter les limites des APIs externes
- Batch: grouper les op√©rations similaires

## üìä DONN√âES & TABLES SUPABASE

### Tables principales
- users (id, email, role, created_at, etc.)
- credits (id_user, amount, type, balance_after, etc.)
- merchants (id, id_user, plan, promo_count, etc.)
- offers (id, id_merchant, title, credits_cost, etc.)
- reservations (id, user_id, offer_id, qr_code, status, etc.)
- reviews (id, user_id, merchant_id, rating, comment, etc.)
- affiliates (id, user_id, rank, commissions, etc.)
- commissions (id, affiliate_id, amount, status, etc.)
- payments (id, user_id, amount, taxes, status, etc.)
- ai_logs (id, user_id, prompt, response, timestamp, etc.)
- logs_audit (id, action, user_id, timestamp, ip, etc.)
- legal_consents (id, user_id, type, version, ip, etc.)
- notifications_log (id, user_id, channel, message, status, etc.)

### RLS (Row Level Security)
- Activ√© sur toutes les tables sensibles
- Chaque utilisateur ne voit que ses donn√©es
- Admin a acc√®s global (r√¥le sp√©cial)
- Support a acc√®s limit√© (lecture seulement)

### Indexes critiques
- email (unique)
- user_id (sur credits, reservations, commissions, etc.)
- created_at (pour tri/filtrage dates)
- merchant_id (pour offres li√©es)
- status (pour filtres √©tat)

## ü§ñ R√àGLES IA (OpenAI)

### Agents IA (3 types)

#### Agent Commer√ßant
- G√©n√®re: titre offre + description + texte promo
- G√©n√®re: visuel Canva (image promo)
- Locale: expressions qu√©b√©coises
- Tempo: < 5 minutes total
- Contr√¥le qualit√©: filtrage contenu inappropri√©

#### Agent Consommateur
- Recommande: offres personnalis√©es (g√©oloc + pr√©f√©rences)
- Localise: par ville, cat√©gorie, prix en cr√©dits
- Tempo: < 2 secondes
- Memoria: historique utilisateur (Supabase)

#### Agent Affili√©
- Fourni: scripts d'approche
- Fourni: plan d'action strat√©gique
- Fourni: formation continue
- Locale: terminologie affili√© 2.0

### Limites mensuelles
- Bronze: 10 requ√™tes IA/mois
- Argent: 50 requ√™tes IA/mois
- Or: illimit√©
- Quotas g√©r√©s par Supabase triggers

### S√©curit√© IA
- Pas d'envoi PII vers OpenAI
- Stockage r√©ponses: Supabase ai_logs
- Filtrage: contenu toxique/ill√©gal d√©tect√©
- Logs: toute requ√™te trac√©e (ai_logs)

## üì± RESPONSIVE & UX

### Breakpoints
- Mobile: < 600px
- Tablet: 600px - 1024px
- Desktop: > 1024px

### Mobile-first
- Conception: mobile d'abord
- Navigation: menu hamburger < 768px
- Buttons: min 44px (WCAG)
- Texte: min 16px pour lisibilit√©
- Spacing: g√©n√©reux, tactile-friendly

### Accessibilit√©
- Contraste: AA minimum (WCAG)
- Navigation clavier: compl√®te (tab-index)
- Labels: tous les champs ont labels lisibles
- Images: alt-text fourni
- Couleurs: pas unique moyen d'info

## üìù COMMENTAIRES & DOCUMENTATION

### Commentaires requis
- Fonctions: d√©crire param√®tres + retour
- Sections critiques: logique complexe expliqu√©e
- TODO/FIXME: accept√©s mais √† r√©soudre avant merge
- Format: `// Ceci est un commentaire` en fran√ßais

### Exemple bon commentaire
```javascript
// Cr√©e un nouveau cr√©dit utilisateur et met √† jour le solde
// Params: user_id (UUID), amount (number), type (enum: purchase|reward|use)
// Return: { created: boolean, new_balance: number }
function creerCredit(userId, amount, type) {
  // Valide le montant (doit √™tre > 0)
  if (amount <= 0) throw new Error("Montant invalide");
  
  // R√©cup√®re le solde actuel depuis Supabase
  const currentBalance = await obtenirSolde(userId);
  
  // Ajoute le cr√©dit
  const newBalance = currentBalance + amount;
  
  // Enregistre dans Supabase + audit log
  return { created: true, new_balance: newBalance };
}
```

## üß™ TESTS & VALIDATION

### Avant de livrer
- Tests manuels: cas nominaux + cas d'erreur
- Validation schema: JSON/SQL valid√©
- Erreurs: tous les chemins d'erreur test√©s
- Performance: latence < 3s mesur√©e
- Mobile: test√© sur mobile et tablet

### Checklist livraison
- ‚úÖ Code complet (pas de TODO non-r√©solus)
- ‚úÖ Commentaires fran√ßais pr√©sents
- ‚úÖ Erreurs g√©r√©es + logu√©es
- ‚úÖ S√©curit√© valid√©e (RLS, HTTPS, etc.)
- ‚úÖ Loi 25 respect√©e
- ‚úÖ Mobile-first responsive
- ‚úÖ Performance acceptable
- ‚úÖ Audit trail logg√©

## üöÄ STRUCTURE DE R√âPONSE CLAUDE CODE

Quand tu me demandes du code, fournis:

1. **Contexte**: Module (A-M), cas d'usage
2. **D√©tails**: Qui? Quoi? O√π? Quand? Pourquoi?
3. **Int√©grations**: Services externes impliqu√©s
4. **S√©curit√©**: Qui peut acc√©der? Conformit√©?
5. **Erreurs**: Cas d'√©chec √† g√©rer

Exemple bon prompt:
```
"Module B (Cr√©dits) :
Cr√©e un webhook Make qui :
1. Re√ßoit une confirmation paiement Payments.AI
2. Valide signature HMAC
3. Cr√©e entr√©e payments + credits dans Supabase
4. Envoie facture PDF via MailerSend
5. Ajoute dans audit_log

Respecte idempotence + gestion d'erreurs + logs complets"
```

## üìû FICHIERS DE R√âF√âRENCE

- Document_Maitre.md: Cahier de charge COMPLET (sections 1-12)
- config.json: Configuration projet (prix, modules, timelines)
- Cette r√®gle (.claude_rules): Standards de code

## üéØ OBJECTIFS CL√âS 2026

- Utilisateurs: 50 000 inscrits (10 000 actifs)
- Commer√ßants: 5 000 (40% payants)
- Affili√©s: 2 500 actifs (25% level B√¢tisseur+)
- Offres IA: 60% g√©n√©r√©es automatiquement
- Platform uptime: 99.5%
- NPS: 8/10

## ‚ö° PRIORIT√âS ACTUELLES (Septembre - D√©cembre 2025)

Phase A - MVP:
- 3 tunnels d'inscription ‚úÖ
- Base Supabase fonctionnelle ‚úÖ
- Automatisations Make essentielles üîÑ
- Webhooks GoAffPro reli√©s üîÑ
- Emails onboarding ‚úÖ

Phase B - Beta (F√©vrier - Mai 2026):
- Paiements entrants (Payments.AI + PayPal)
- IA Commer√ßant v1 (g√©n√©ration promos)
- IA Consommateur v1 (recommandations)
- Retool Admin complet
- Rapports TPS/TVQ automatiques


# ============================================================================
# üèóÔ∏è STRUCTURE MODULAIRE - ORGANISATION DES MODULES
# ============================================================================

## Principe directeur
Chaque module est une unit√© ind√©pendante, isol√©e, et r√©utilisable.
Les modules partagent une infrastructure commune, mais NE S'ENTRELACENT PAS.

## Structure de fichiers pour CHAQUE MODULE

Chaque module X doit avoir cette structure :

modules/
‚îî‚îÄ‚îÄ module_x_NOM/
    ‚îú‚îÄ‚îÄ make/
    ‚îÇ   ‚îú‚îÄ‚îÄ webhook_*.json              (1 ou plusieurs webhooks)
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md                   (documentation Make)
    ‚îÇ   ‚îî‚îÄ‚îÄ payloads/
    ‚îÇ       ‚îî‚îÄ‚îÄ exemple_*.json          (exemples de test)
    ‚îÇ
    ‚îú‚îÄ‚îÄ supabase/
    ‚îÇ   ‚îú‚îÄ‚îÄ 01_create_tables.sql        (cr√©ation tables)
    ‚îÇ   ‚îú‚îÄ‚îÄ 02_add_indexes.sql          (indexes et optimisations)
    ‚îÇ   ‚îú‚îÄ‚îÄ 03_add_rls.sql              (Row Level Security)
    ‚îÇ   ‚îú‚îÄ‚îÄ 04_add_functions.sql        (fonctions SQL)
    ‚îÇ   ‚îî‚îÄ‚îÄ 05_add_triggers.sql         (triggers automatiques)
    ‚îÇ
    ‚îú‚îÄ‚îÄ tests/
    ‚îÇ   ‚îú‚îÄ‚îÄ test_*.sh                   (tests bash/curl)
    ‚îÇ   ‚îú‚îÄ‚îÄ test_*.json                 (payloads de test)
    ‚îÇ   ‚îî‚îÄ‚îÄ README.md                   (guide tests)
    ‚îÇ
    ‚îú‚îÄ‚îÄ docs/
    ‚îÇ   ‚îú‚îÄ‚îÄ INSTALLATION.md             (comment installer ce module)
    ‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md             (comment √ßa marche)
    ‚îÇ   ‚îú‚îÄ‚îÄ API.md                      (endpoints et webhooks)
    ‚îÇ   ‚îú‚îÄ‚îÄ TROUBLESHOOTING.md          (erreurs et solutions)
    ‚îÇ   ‚îî‚îÄ‚îÄ DEPENDENCIES.md             (qui d√©pend de quoi ?)
    ‚îÇ
    ‚îú‚îÄ‚îÄ config.json                     (config sp√©cifique au module)
    ‚îî‚îÄ‚îÄ README.md                       (index du module)

## R√®gles d'organisation

1. ‚úÖ JAMAIS mettre les fichiers d'un module ailleurs que dans son dossier
2. ‚úÖ Nommer clairement : module_A_users, module_B_credits, etc.
3. ‚úÖ Num√©roter les fichiers SQL : 01_, 02_, 03_, etc. (ordre d'ex√©cution)
4. ‚úÖ Mettre la documentation DANS le dossier du module
5. ‚úÖ Chaque module doit pouvoir √™tre install√© IND√âPENDAMMENT
6. ‚úÖ Les d√©pendances entre modules doivent √™tre DOCUMENT√âES

## Infrastructure partag√©e (HORS modules)

infrastructure/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/        (migrations globales Supabase)
‚îú‚îÄ‚îÄ make/
‚îÇ   ‚îî‚îÄ‚îÄ shared_workflows/  (workflows r√©utilisables)
‚îî‚îÄ‚îÄ security/
    ‚îî‚îÄ‚îÄ rls_policies.sql   (politiques de s√©curit√© globales)

## INTERDICTIONS

‚ùå Ne PAS m√©langer les fichiers de modules diff√©rents
‚ùå Ne PAS cr√©er de fichiers "g√©n√©riques" qui font plusieurs modules
‚ùå Ne PAS imbriquer les modules les uns dans les autres
‚ùå Ne PAS oublier la documentation dans chaque module

## Exemple : Cr√©er le Module B (Cr√©dits & Paiements)

Si tu demandes : "Cr√©e le Module B pour g√©rer les cr√©dits"

Claude Code DOIT cr√©er :

modules/module_b_credits/
‚îú‚îÄ‚îÄ make/
‚îÇ   ‚îú‚îÄ‚îÄ webhook_achat_credits.json
‚îÇ   ‚îú‚îÄ‚îÄ webhook_utilisation_credits.json
‚îÇ   ‚îú‚îÄ‚îÄ webhook_remboursement_credits.json
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îî‚îÄ‚îÄ payloads/
‚îÇ       ‚îú‚îÄ‚îÄ exemple_achat_50_credits.json
‚îÇ       ‚îú‚îÄ‚îÄ exemple_utilisation_3_credits.json
‚îÇ       ‚îî‚îÄ‚îÄ exemple_remboursement_10_credits.json
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îú‚îÄ‚îÄ 01_create_tables.sql
‚îÇ   ‚îú‚îÄ‚îÄ 02_add_indexes.sql
‚îÇ   ‚îú‚îÄ‚îÄ 03_add_rls.sql
‚îÇ   ‚îú‚îÄ‚îÄ 04_add_functions.sql
‚îÇ   ‚îî‚îÄ‚îÄ 05_add_triggers.sql
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_achat_credits.sh
‚îÇ   ‚îú‚îÄ‚îÄ test_utilisation_credits.sh
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ INSTALLATION.md
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îÇ   ‚îú‚îÄ‚îÄ DEPENDENCIES.md (d√©pend de Module A: users)
‚îÇ   ‚îî‚îÄ‚îÄ TROUBLESHOOTING.md
‚îú‚îÄ‚îÄ config.json
‚îî‚îÄ‚îÄ README.md

## Matrice de d√©pendances

Module A (Users)
  ‚îî‚îÄ> Module B (Credits)
  ‚îî‚îÄ> Module C (Offers)
  ‚îî‚îÄ> Module E (Affiliates)

Module B (Credits)
  ‚îî‚îÄ> Module C (Offers) - r√©servations utilisent les cr√©dits

Module C (Offers)
  ‚îî‚îÄ> Module F (IA) - IA g√©n√®re les offres

Module E (Affiliates)
  ‚îî‚îÄ> Module B (Credits) - commissions = cr√©dits transf√©r√©s

Cette d√©pendance doit √™tre DOCUMENT√âE dans chaque module.

## Index global

√Ä la racine du dossier modules/, cr√©er :

modules/README.md
- Liste de tous les modules
- Matrice de d√©pendances (qui d√©pend de qui)
- Ordre recommand√© d'installation
- Liens vers chaque module
---

**Derni√®re mise √† jour**: 9 novembre 2025
**Auteur**: Claude (en collaboration avec Dany Gosselin)
**Statut**: ‚úÖ ACTIF
