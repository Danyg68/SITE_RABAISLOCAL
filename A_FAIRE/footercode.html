<!-- ====== BANDEAU COOKIES RABAISLOCAL – version universelle ====== -->
<style>
  .rl-cookie-bar{position:fixed;left:0;right:0;bottom:0;background:#ffffff;border-top:1px solid #E3E8FF;box-shadow:0 -6px 24px rgba(0,0,0,.08);z-index:9999;
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#1B2240}
  .rl-cookie-wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:16px;align-items:center}
  .rl-cookie-text{font-size:14px;line-height:1.5;flex:1}
  .rl-cookie-actions{display:flex;gap:8px}
  .rl-btn{border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  .rl-btn-primary{background:#3E53A5;color:#fff}
  .rl-btn-ghost{background:#F5F8FF;color:#1B2240;border:1px solid #E3E8FF}
  .rl-cookie-link{color:#3E53A5;text-decoration:underline}
  .rl-cookie-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10000}
  .rl-cookie-card{background:#fff;border:1px solid #E3E8FF;border-radius:14px;width:min(680px,92vw);padding:18px}
  .rl-cookie-card h3{margin:0 0 10px;color:#3E53A5}
  .rl-row{display:flex;justify-content:space-between;align-items:center;border:1px solid #E3E8FF;border-radius:10px;padding:10px 12px;margin:8px 0}
  .rl-switch{position:relative;width:48px;height:26px;background:#E3E8FF;border-radius:999px;cursor:pointer}
  .rl-switch input{display:none}
  .rl-switch span{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2);transition:.2s}
  .rl-switch input:checked + span{left:25px;background:#3E53A5}
  @media(max-width:720px){.rl-cookie-wrap{flex-direction:column;align-items:flex-start}}
</style>

<div class="rl-cookie-bar" id="rlCookieBar">
  <div class="rl-cookie-wrap">
    <div class="rl-cookie-text">
      Nous utilisons des cookies pour le fonctionnement du site (nécessaires), mesurer l’audience (Analytics) et, si tu l’acceptes, améliorer nos contenus (fonctionnels) et nos campagnes (marketing).
      <a class="rl-cookie-link" href="/politique-cookies">En savoir plus</a>.
    </div>
    <div class="rl-cookie-actions">
      <button class="rl-btn rl-btn-ghost" id="rlCookieRefuse">Tout refuser</button>
      <button class="rl-btn rl-btn-ghost" id="rlCookiePrefs">Personnaliser</button>
      <button class="rl-btn rl-btn-primary" id="rlCookieAccept">Tout accepter</button>
    </div>
  </div>
</div>

<div class="rl-cookie-modal" id="rlCookieModal" aria-hidden="true">
  <div class="rl-cookie-card" role="dialog" aria-modal="true" aria-labelledby="rlCookieTitle">
    <h3 id="rlCookieTitle">Préférences des cookies</h3>
    <div class="rl-row"><div><strong>Nécessaires</strong> – indispensables au fonctionnement (toujours actifs)</div><div class="rl-switch"><input type="checkbox" checked disabled><span></span></div></div>
    <div class="rl-row"><div><strong>Mesure d’audience</strong> (Google Analytics/Tag Manager)</div><label class="rl-switch"><input type="checkbox" id="cAnalytics"><span></span></label></div>
    <div class="rl-row"><div><strong>Fonctionnels</strong> (préférences, confort d’usage)</div><label class="rl-switch"><input type="checkbox" id="cFunctional"><span></span></label></div>
    <div class="rl-row"><div><strong>Marketing</strong> (Meta, TikTok, YouTube)</div><label class="rl-switch"><input type="checkbox" id="cMarketing"><span></span></label></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="rl-btn rl-btn-ghost" id="rlPrefsCancel">Annuler</button>
      <button class="rl-btn rl-btn-primary" id="rlPrefsSave">Enregistrer</button>
    </div>
  </div>
</div>

<script>
setTimeout(() => {
(function(){
  const BAR = document.getElementById('rlCookieBar');
  const MODAL = document.getElementById('rlCookieModal');
  const LSKEY = 'rlConsent';

  function getConsent(){
    try{ return JSON.parse(localStorage.getItem(LSKEY)) || null }catch(e){ return null }
  }
  function saveConsent(obj){ localStorage.setItem(LSKEY, JSON.stringify(obj)); }
  function hideBar(){ if(BAR) BAR.style.display='none'; }
  function showBar(){ if(BAR) BAR.style.display='block'; }
  function openModal(){ MODAL.style.display='flex'; }
  function closeModal(){ MODAL.style.display='none'; }

  function applyConsent(c){
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent','default',{
      'ad_storage':c && c.marketing?'granted':'denied',
      'analytics_storage':c && c.analytics?'granted':'denied',
      'functionality_storage':c && c.functional?'granted':'denied',
      'security_storage':'granted'
    });
  }

  const existing = getConsent();
  if(existing){ hideBar(); applyConsent(existing); } else { showBar(); }

  const wait = setInterval(() => {
    const accept = document.getElementById('rlCookieAccept');
    const refuse = document.getElementById('rlCookieRefuse');
    const prefs = document.getElementById('rlCookiePrefs');
    const save = document.getElementById('rlPrefsSave');
    const cancel = document.getElementById('rlPrefsCancel');
    const cAn = document.getElementById('cAnalytics');
    const cFn = document.getElementById('cFunctional');
    const cMk = document.getElementById('cMarketing');
    if (accept && refuse && prefs && save && cancel) {
      clearInterval(wait);
      accept.onclick = () => { const c={analytics:true,functional:true,marketing:true}; saveConsent(c); hideBar(); applyConsent(c); };
      refuse.onclick = () => { const c={analytics:false,functional:false,marketing:false}; saveConsent(c); hideBar(); applyConsent(c); };
      prefs.onclick = openModal;
      save.onclick = () => { const c={analytics:cAn.checked,functional:cFn.checked,marketing:cMk.checked}; saveConsent(c); closeModal(); hideBar(); applyConsent(c); };
      cancel.onclick = closeModal;
    }
  }, 400);
})();
}, 700);
</script>

<!-- ================================
  RABAISLOCAL • REF TRACKER GLOBAL
  Version stable 2025 – pour ClickFunnels 2.0
  Fonctions :
  - Capture ?ref / ?rl_ref / ?referred_by
  - Stockage cookie + localStorage (180 jours)
  - Injection dans tous les <form>
  - Propagation du ?ref=... sur tous les liens internes
  - Sauvegarde avant redirection instantanée (ClickFunnels AJAX)
================================== -->
<script>
(function(){
  "use strict";

  /* === OUTILS === */
  function getParam(name){
    try {
      var p = new URLSearchParams(window.location.search);
      return p.get(name) || "";
    } catch(e){ return ""; }
  }
  function sanitize(v){ return (v || "").toString().replace(/[^\w\-]/g, "").trim(); }
  function setCookie(n,v,days){
    try {
      var t=new Date();
      t.setTime(t.getTime()+days*24*60*60*1000);
      document.cookie=n+"="+encodeURIComponent(v)+";expires="+t.toUTCString()+";path=/";
    } catch(e){}
  }
  function getCookie(n){
    try {
      var m=document.cookie.match(new RegExp("(^| )"+n+"=([^;]+)"));
      return m?decodeURIComponent(m[2]):"";
    } catch(e){ return ""; }
  }
  function setLS(k,v){ try{localStorage.setItem(k,v);}catch(e){} }
  function getLS(k){ try{return localStorage.getItem(k)||"";}catch(e){return"";} }

  /* === CAPTURE DU REF === */
  var refURL = getParam("ref") || getParam("rl_ref") || getParam("referred_by");
  var refCookie = getCookie("rl_ref");
  var refLS = getLS("rl_ref");
  var REF = sanitize(refURL || refCookie || refLS);

  // Persistance
  if(refURL){
    REF = sanitize(refURL);
    setCookie("rl_ref", REF, 180);
    setLS("rl_ref", REF);
  } else if(REF){
    setCookie("rl_ref", REF, 180);
    setLS("rl_ref", REF);
  }

  /* === INJECTION DANS LES FORMULAIRES === */
  function injectHiddenRef(){
    var val = REF || "";
    document.querySelectorAll("form").forEach(function(f){
      if(!f.querySelector('input[name="rl_ref"]')){
        var i=document.createElement("input");
        i.type="hidden";
        i.name="rl_ref";
        i.value=val;
        f.appendChild(i);
      } else {
        var ex=f.querySelector('input[name="rl_ref"]');
        if(!ex.value && val) ex.value=val;
      }
    });
  }

  /* === PROPAGATION SUR LES LIENS INTERNES === */
  function propagateLinks(){
    if(!REF) return;
    document.querySelectorAll("a[href]").forEach(function(a){
      var href=a.getAttribute("href");
      if(!href || href.startsWith("mailto:") || href.startsWith("tel:") || href.startsWith("javascript:") || href.startsWith("#")) return;
      try{
        var url=new URL(href, window.location.origin);
        if(url.origin!==window.location.origin) return;
        if(!url.searchParams.get("ref") && !url.searchParams.get("rl_ref")){
          url.searchParams.set("ref", REF);
        }
        a.setAttribute("href", url.toString());
      }catch(e){
        if(href.indexOf("?")===-1) a.setAttribute("href", href+"?ref="+encodeURIComponent(REF));
        else if(!/[?&](ref|rl_ref)=/i.test(href))
          a.setAttribute("href", href+"&ref="+encodeURIComponent(REF));
      }
    });
  }

  /* === EXECUTION PRINCIPALE === */
  function run(){
    if(!REF) REF = sanitize(getLS("rl_ref") || getCookie("rl_ref"));
    injectHiddenRef();
    propagateLinks();
  }

  // Exécution après chargement complet + sur mutation (DOM ClickFunnels dynamique)
  window.addEventListener("load", run);
  var mo = new MutationObserver(run);
  mo.observe(document.documentElement, {childList:true, subtree:true});

  /* === SAUVEGARDE AVANT REDIRECTION === */
  document.addEventListener('click', function(e){
    if(e.target.closest('button, a')){
      try{
        if(REF){
          setLS('rl_ref', REF);
          setCookie('rl_ref', REF, 180);
        }
      }catch(err){}
    }
  });

})();
</script>
