<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RabaisLocal â€“ Inscription CommerÃ§ant</title>

  <!-- Google Fonts - Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="assets/images/favicon.ico">

  <style>
    /* ================================================
   RABAISLOCAL - PAGE INSCRIPTION COMMERÃ‡ANT
   Variables & Reset
   ================================================ */
    :root {
      --rl-blue: #3E53A5;
      --rl-blue-dark: #2E4191;
      --rl-danger: #E53935;
      --rl-purple: #5A4FCF;
      --bg: #F5F8FF;
      --bg-light: #EEF2FF;
      --card: #F8F9FF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg);
      color: #1B2240;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    h1,
    h2,
    h3 {
      margin: 0;
      font-weight: 700;
    }

    /* ================================================
   HEADER
   ================================================ */
    .header {
      text-align: center;
      padding: 25px 15px 15px;
      background: #ffffff;
    }

    .header .logo {
      max-width: 280px;
      height: auto;
      display: inline-block;
      margin: 0 auto;
    }

    /* ================================================
   HERO SECTION
   ================================================ */
    .hero {
      text-align: center;
      padding: 50px 20px 25px;
      background: var(--bg);
    }

    .hero h1 {
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 700;
      color: var(--rl-blue);
      line-height: 1.35;
      margin-bottom: 12px;
    }

    .hero h1 span {
      color: var(--rl-danger);
      font-weight: 700;
    }

    .hero p {
      margin-top: 12px;
      font-size: clamp(1.05rem, 2vw, 1.15rem);
      color: #1B2240;
      font-weight: 500;
    }

    /* ================================================
   BANNERS
   ================================================ */
    .banner {
      background-color: var(--rl-blue);
      padding: 13px 20px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      font-size: 1.05rem;
      color: #FFFFFF;
      margin: 15px auto;
      max-width: fit-content;
      box-shadow: 0 4px 12px rgba(62, 83, 165, 0.25);
    }

    .banner span {
      font-weight: 700;
    }

    .social-proof {
      background-color: var(--rl-purple);
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      margin: 15px auto;
      max-width: fit-content;
      box-shadow: 0 4px 12px rgba(90, 79, 207, 0.3);
    }

    /* ================================================
   MAIN CONTENT - 2 COLONNES
   ================================================ */
    .main-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      max-width: 1180px;
      margin: 40px auto;
      padding: 45px 25px;
      background-color: var(--bg-light);
      border-radius: 14px;
    }

    /* ================================================
   COLONNE GAUCHE - VidÃ©o + Formulaire
   ================================================ */
    .left-column {
      flex: 1 1 560px;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    /* VidÃ©o responsive 16:9 */
    .video {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      /* Ratio 16:9 */
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.18);
      background: #000;
    }

    .video iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 14px;
    }

    /* ================================================
   FORMULAIRE
   ================================================ */
    .form-section {
      background: var(--card);
      padding: 35px 38px;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
      border: 1px solid #E3E8FF;
    }

    .form-section .kicker {
      color: var(--rl-blue);
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 6px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-section h3 {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 22px;
      color: #0B1220;
      line-height: 1.4;
    }

    .form-section input[type="text"],
    .form-section input[type="email"] {
      width: 100%;
      padding: 13px 15px;
      margin-bottom: 14px;
      border: 1px solid #D4D8F0;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-section input:focus {
      outline: none;
      border-color: var(--rl-blue);
      box-shadow: 0 0 0 3px rgba(62, 83, 165, 0.1);
    }

    .form-section label {
      font-size: 0.92rem;
      display: flex;
      align-items: flex-start;
      margin-bottom: 18px;
      color: #444;
      line-height: 1.5;
    }

    .form-section label input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      margin-top: 3px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .form-section button {
      width: 100%;
      padding: 15px 20px;
      background-color: var(--rl-danger);
      color: #fff;
      font-weight: 700;
      font-size: 1.08rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 18px rgba(229, 57, 53, 0.35);
    }

    .form-section button:hover {
      background-color: #c93131;
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(229, 57, 53, 0.45);
    }

    .form-section button:active {
      transform: translateY(0);
    }

    /* ================================================
   COLONNE DROITE - Avantages
   ================================================ */
    .avantages {
      flex: 1 1 450px;
      max-width: 520px;
      background-color: #FFFFFF;
      border: 1px solid rgba(62, 83, 165, 0.12);
      border-radius: 14px;
      padding: 30px 35px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      align-self: stretch;
    }

    .avantages h3 {
      color: var(--rl-blue);
      font-size: 1.4rem;
      margin-bottom: 24px;
      font-weight: 700;
    }

    .avantages ul {
      list-style: none;
      padding: 0;
      margin: 0;
      line-height: 1.7;
    }

    .avantages li {
      margin-bottom: 14px;
      font-size: 1rem;
      position: relative;
      padding-left: 32px;
      color: #1B2240;
    }

    .avantages li::before {
      content: "âœ…";
      position: absolute;
      left: 0;
      top: 0;
      font-size: 1.1rem;
      color: var(--rl-blue);
    }

    .avantages b {
      color: var(--rl-danger);
      font-weight: 700;
    }

    .avantages-bottom {
      text-align: center;
      font-size: 1rem;
      color: #1B2240;
      margin-top: 28px;
      line-height: 1.6;
    }

    .avantages-bottom hr {
      border: none;
      height: 1px;
      background: #D8DAE6;
      margin: 24px 0;
    }

    .avantages-bottom b {
      color: #0B1220;
      font-weight: 700;
    }

    .avantages-bottom span {
      color: var(--rl-danger);
      font-weight: 700;
    }

    .avantages-bottom img {
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      margin-top: 18px;
      width: 100%;
      max-width: 400px;
    }

    .avantages-bottom p.caption {
      font-size: 0.88rem;
      color: #6B6F82;
      margin-top: 8px;
      font-style: italic;
    }

    /* ================================================
   OVERLAY REDIRECTION
   ================================================ */
    .redirect-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(245, 248, 255, 0.97);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      color: #1B2240;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
    }

    .redirect-overlay span {
      display: block;
      margin-top: 18px;
      font-size: 1.05rem;
      color: var(--rl-blue);
      font-weight: 600;
    }

    /* ================================================
   FOOTER
   ================================================ */
    .footer {
      background-color: var(--rl-blue);
      color: #fff;
      padding: 28px 20px;
      text-align: center;
      margin-top: 60px;
    }

    .footer .logo {
      max-width: 180px;
      display: block;
      margin: 0 auto 14px;
    }

    .footer p {
      margin: 10px 0 0;
      font-size: 0.95rem;
      font-weight: 400;
    }

    /* ================================================
   RESPONSIVE - MOBILE
   ================================================ */
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
        padding: 30px 18px;
        gap: 28px;
      }

      .left-column,
      .avantages {
        flex: 1 1 100%;
        max-width: 100%;
      }

      .hero {
        padding: 35px 18px 20px;
      }

      .hero h1 {
        font-size: 1.65rem;
      }

      .hero p {
        font-size: 1rem;
      }

      .form-section {
        padding: 28px 24px;
      }

      .avantages {
        padding: 25px 24px;
      }

      .banner,
      .social-proof {
        font-size: 0.95rem;
        padding: 11px 16px;
      }
    }

    @media (max-width: 480px) {
      .header .logo {
        max-width: 220px;
      }

      .hero h1 {
        font-size: 1.5rem;
      }

      .form-section {
        padding: 24px 20px;
      }

      .form-section button {
        font-size: 1rem;
        padding: 13px 18px;
      }

      .avantages {
        padding: 22px 20px;
      }

      .avantages li {
        font-size: 0.95rem;
      }
    }

    /* ================================================
   ACCESSIBILITÃ‰
   ================================================ */
    a:focus,
    button:focus,
    input:focus {
      outline: 2px solid var(--rl-blue);
      outline-offset: 3px;
    }

    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ================================================
   ALERTES
   ================================================ */
    .alert {
      display: none;
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      text-align: left;
    }

    .alert-success {
      background: #e7f6ec;
      border: 1px solid #b8e0c7;
      color: #0f5132;
    }

    .alert-error {
      background: #fdeceb;
      border: 1px solid #f5c2c0;
      color: #842029;
    }
  </style>
</head>

<body>

  <!-- ================================================
     HEADER
     ================================================ -->
  <header class="header">
    <img src="assets/images/logo rabaislocal-2025-2.png" alt="RabaisLocal" class="logo">
  </header>

  <!-- ================================================
     HERO SECTION
     ================================================ -->
  <section class="hero">
    <h1>
      365 jours de visibilitÃ©... <span>zÃ©ro commission</span> et gardez <span>100 % de vos ventes !</span>
    </h1>
    <p>Publiez vos offres en quelques clics, l'IA s'occupe du reste !</p>
  </section>

  <!-- ================================================
     BANNER
     ================================================ -->
  <div class="banner">
    âš¡ <span>ZÃ©ro commission</span> <strong>et</strong> <span>sans prise de tÃªte !</span>
  </div>

  <!-- Social Proof (commentÃ©, Ã  activer si besoin) -->
  <!-- <div class="social-proof">
  ðŸ§© DÃ©jÃ  plus de <b>2 800 commerÃ§ants et consommateurs</b> inscrits au prÃ©-lancement au QuÃ©bec.
</div> -->

  <!-- ================================================
     SECTION PRINCIPALE - 2 COLONNES
     ================================================ -->
  <section class="main-content">

    <!-- ================================================
       COLONNE GAUCHE - VidÃ©o + Formulaire
       ================================================ -->
    <div class="left-column">

      <!-- VidÃ©o YouTube -->
      <div class="video">
        <iframe src="https://www.youtube.com/embed/728F2sdyn3k?autoplay=1&mute=1&rel=0&showinfo=0"
          title="PrÃ©sentation RabaisLocal - CommerÃ§ants"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>

      <!-- Formulaire d'inscription -->
      <div class="form-section" id="formulaire">
        <div class="kicker">Inscription gratuite</div>
        <h3>Rejoignez dÃ¨s maintenant les commerÃ§ants du prÃ©-lancement RabaisLocal</h3>

        <form id="rlForm" action="https://hook.us2.make.com/b3foxids3cmxgj2nv7vghhehxk38dawn" method="POST" novalidate>

          <!-- Zone d'alerte -->
          <div id="form-alert" class="alert"></div>

          <!-- Champ cachÃ© pour le numÃ©ro de parrain -->
          <input type="hidden" name="ref" id="ref" value="">

          <input type="text" name="prenom" placeholder="PrÃ©nom" pattern="[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿' -]{2,60}" maxlength="60"
            required autocomplete="given-name">

          <input type="text" name="nom" placeholder="Nom" pattern="[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿' -]{2,60}" maxlength="60" required
            autocomplete="family-name">

          <input type="text" name="commerce" placeholder="Nom du commerce" maxlength="120" required
            autocomplete="organization">

          <input type="text" name="code_postal" placeholder="Code postal (ex: H2X 1Y4)"
            pattern="[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d" title="Format: A1A 1A1 (ex: H2X 1Y4)" maxlength="7" required
            autocomplete="postal-code">

          <input type="email" name="email" placeholder="Votre courriel" pattern="[^\s@]+@[^\s@]+\.[^\s@]+"
            maxlength="120" title="Veuillez entrer une adresse courriel valide (ex: nom@exemple.com)" required
            autocomplete="email">

          <label>
            <input type="checkbox" required>
            <span>J'accepte les <a href="https://www.rabaislocal.net/conditions-utilisation" target="_blank"
                style="color:#3E53A5;text-decoration:underline;">conditions gÃ©nÃ©rales</a></span>
          </label>

          <button type="submit">
            ðŸ§­ Inscrire mon commerce gratuitement
          </button>
        </form>
      </div>
    </div>

    <!-- ================================================
       COLONNE DROITE - Avantages
       ================================================ -->
    <div class="avantages">
      <h3>ðŸŽ¯ Avantages exclusifs du prÃ©-lancement</h3>
      <ul>
        <li><b>ZÃ©ro commission Ã  vie</b> â€” gardez 100 % de vos ventes.</li>
        <li><b>VisibilitÃ© 365 jours/an</b> â€” votre commerce reste en vitrine toute l'annÃ©e.</li>
        <li><b>Agent IA</b> "Mon agent marketing personnalisÃ©"</li>
        <li><b>CrÃ©ation et mise en ligne de vos promotions en moins de 20 minutes</b> grÃ¢ce Ã  l'IA.</li>
        <li><b>AccÃ¨s Ã  toutes les styles</b> de campagnes promotionnelles</li>
        <li><b>3 mois gratuits au 1000 premiers commerces inscrits</b> Ã  toutes les fonctionnalitÃ©s en lien avec le
          commerÃ§ant.</li>
        <li><b>Page vitrine personnalisÃ©e</b> avec badge <b>Membre PrivilÃ¨ge</b>.</li>
        <li><b>Mise en avant prioritaire</b> dans votre rÃ©gion dÃ¨s le lancement.</li>
        <li><b>AccÃ¨s anticipÃ©</b> Ã  toutes les nouvelles fonctionnalitÃ©s.</li>
        <li><b>Support et accompagnement local</b> pour publier vos offres facilement.</li>
      </ul>

      <div class="avantages-bottom">
        <hr>
        ðŸ’¡ En vous inscrivant aujourd'hui, vous ferez partie des <b>1 000 premiers commerces</b> Ã  tester la plateforme
        gratuitement avant le lancement officiel.
        <br><span>Places limitÃ©es !</span>
        <!-- TODO: Ajouter image si disponible -->
      </div>
    </div>

  </section>

  <!-- ================================================
     OVERLAY REDIRECTION
     ================================================ -->
  <div class="redirect-overlay" id="redirectOverlay">
    âœ… Merci pour votre inscription !
    <span>Redirection en cours vers la page de confirmation...</span>
  </div>

  <!-- ================================================
     FOOTER
     ================================================ -->
  <footer class="footer">
    <div class="container">
      <img src="assets/images/e5cab6b1bd46651f9eac704e82ff0f77_12f12a9e.png" alt="RabaisLocal" class="logo">
      <p>Â© 2025 <strong>RabaisLocal</strong> â€” Tous droits rÃ©servÃ©s</p>
    </div>
  </footer>

  <!-- ================================================
     JAVASCRIPT - TRACKING REF & SOUMISSION FORMULAIRE
     ================================================ -->
  <script>
    (function () {
      "use strict";

      /* ====================================================
         UTILITAIRES
         ==================================================== */
      function getParam(name) {
        try {
          const params = new URLSearchParams(window.location.search);
          return params.get(name) || '';
        } catch (e) {
          return '';
        }
      }

      function sanitize(value) {
        return (value || '').toString().replace(/[^\w\-]/g, '').trim();
      }

      function normalizeName(value) {
        return (value || '').replace(/[^A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿' -]/g, '').trim();
      }

      function normalizeEmail(value) {
        return (value || '').toString().trim().toLowerCase().replace(/\s+/g, '');
      }

      function normalizePostal(value) {
        const cleaned = (value || '').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 6);
        if (cleaned.length <= 3) return cleaned;
        return cleaned.slice(0, 3) + ' ' + cleaned.slice(3);
      }

      function isValidPostal(value) {
        return /^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/.test(value || '');
      }

      function normalizeBusiness(value) {
        return (value || '').replace(/[^A-Za-z0-9Ã€-Ã–Ã˜-Ã¶Ã¸-Ã¿' .,&-]/g, '').trim();
      }

      function setCookie(name, value, days) {
        try {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + date.toUTCString() + ";path=/";
        } catch (e) { }
      }

      function getCookie(name) {
        try {
          const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
          return match ? decodeURIComponent(match[2]) : '';
        } catch (e) {
          return '';
        }
      }

      function setLS(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) { }
      }

      function getLS(key) {
        try {
          return localStorage.getItem(key) || '';
        } catch (e) {
          return '';
        }
      }

      /* ====================================================
         CAPTURE ET GESTION DU REF
         ==================================================== */

      // RÃ©cupÃ©ration du ref depuis URL, cookies ou localStorage
      const refFromURL = getParam('ref') || getParam('rl_ref') || getParam('referred_by');
      const refFromCookie = getCookie('rl_ref');
      const refFromLS = getLS('rl_ref');

      // PrioritÃ©: URL > localStorage > Cookie
      let REF = sanitize(refFromURL || refFromLS || refFromCookie);

      // Persistance du REF
      if (refFromURL) {
        REF = sanitize(refFromURL);
        setCookie('rl_ref', REF, 180);
        setLS('rl_ref', REF);
      } else if (REF) {
        // RafraÃ®chir la durÃ©e
        setCookie('rl_ref', REF, 180);
        setLS('rl_ref', REF);
      }

      console.log('âœ… REF capturÃ© sur page commerÃ§ant:', REF || '(aucun parrain)');

      /* ====================================================
         INJECTION DU REF DANS LE CHAMP CACHÃ‰
         ==================================================== */
      function setHiddenRef() {
        const field = document.getElementById('ref');
        if (field && REF) {
          field.value = REF;
          console.log('âœ… REF injectÃ© dans le formulaire:', REF);
        }
      }

      /* ====================================================
         PROPAGATION DU REF DANS TOUS LES LIENS
         ==================================================== */
      function propagateLinks() {
        if (!REF) return;

        document.querySelectorAll('a[href]').forEach(function (link) {
          const href = link.getAttribute('href');

          // Ignorer les liens spÃ©ciaux
          if (!href ||
            href.startsWith('mailto:') ||
            href.startsWith('tel:') ||
            href.startsWith('javascript:') ||
            href.startsWith('#')) {
            return;
          }

          try {
            const url = new URL(href, window.location.origin);

            // Ajouter le ref si pas dÃ©jÃ  prÃ©sent
            if (!url.searchParams.get('ref') && !url.searchParams.get('rl_ref')) {
              url.searchParams.set('ref', REF);
              link.setAttribute('href', url.toString());
            }
          } catch (e) {
            // Fallback pour URLs relatives
            if (href.indexOf('?') === -1) {
              link.setAttribute('href', href + '?ref=' + encodeURIComponent(REF));
            } else if (!/[?&](ref|rl_ref)=/i.test(href)) {
              link.setAttribute('href', href + '&ref=' + encodeURIComponent(REF));
            }
          }
        });
      }

      /* ====================================================
         EXÃ‰CUTION AU CHARGEMENT
         ==================================================== */
      document.addEventListener('DOMContentLoaded', function () {
        setHiddenRef();
        propagateLinks();
      });

      // Observer les changements du DOM
      const observer = new MutationObserver(function () {
        setHiddenRef();
        propagateLinks();
      });
      observer.observe(document.documentElement, {
        childList: true,
        subtree: true
      });

      /* ====================================================
         GESTION DES ALERTES
         ==================================================== */
      function setAlert(type, message) {
        const box = document.getElementById('form-alert');
        if (!box) return;
        box.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
        box.innerHTML = message;
        box.style.display = 'block';
        box.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function clearAlert() {
        const box = document.getElementById('form-alert');
        if (box) {
          box.style.display = 'none';
          box.textContent = '';
          box.className = 'alert';
        }
      }

      /* ====================================================
         GESTION DU FORMULAIRE - ENVOI + REDIRECTION
         ==================================================== */
      const form = document.getElementById('rlForm');
      const overlay = document.getElementById('redirectOverlay');

      if (form && overlay) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          clearAlert();

          // ===== VALIDATION PERSONNALISÃ‰E =====

          const prenomInput = form.querySelector('input[name="prenom"]');
          const nomInput = form.querySelector('input[name="nom"]');
          const commerceInput = form.querySelector('input[name="commerce"]');
          const codePostalInput = form.querySelector('input[name="code_postal"]');
          const emailInput = form.querySelector('input[name="email"]');

          const prenom = normalizeName(prenomInput?.value);
          prenomInput.value = prenom;
          if (!prenom || prenom.length < 2) {
            setAlert('error', 'Attention : Veuillez entrer votre prÃ©nom (2 caractÃ¨res minimum).');
            prenomInput?.focus();
            return;
          }

          const nom = normalizeName(nomInput?.value);
          nomInput.value = nom;
          if (!nom || nom.length < 2) {
            setAlert('error', 'Attention : Veuillez entrer votre nom (2 caractÃ¨res minimum).');
            nomInput?.focus();
            return;
          }

          const commerce = normalizeBusiness(commerceInput?.value);
          commerceInput.value = commerce;
          if (!commerce || commerce.length < 2) {
            setAlert('error', 'Attention : Veuillez entrer le nom de votre commerce.');
            commerceInput?.focus();
            return;
          }

          const codePostal = normalizePostal(codePostalInput?.value);
          codePostalInput.value = codePostal;
          if (!isValidPostal(codePostal)) {
            setAlert('error', 'Attention : Format du code postal invalide. Utilisez le format A1A 1A1 (ex: H2X 1Y4).');
            codePostalInput?.focus();
            return;
          }

          const userEmail = normalizeEmail(emailInput?.value);
          emailInput.value = userEmail;
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!userEmail) {
            setAlert('error', 'Attention : Veuillez entrer votre adresse courriel.');
            emailInput?.focus();
            return;
          }
          if (!emailRegex.test(userEmail)) {
            setAlert('error', 'Attention : Format d\'adresse courriel invalide. Utilisez un format valide (ex: nom@exemple.com).');
            emailInput?.focus();
            return;
          }

          const checkboxInput = form.querySelector('input[type="checkbox"]');
          if (checkboxInput && !checkboxInput.checked) {
            setAlert('error', 'Attention : Vous devez accepter les conditions gÃ©nÃ©rales.');
            checkboxInput.focus();
            return;
          }

          // ===== FIN DE LA VALIDATION =====

          // Sauvegarder le REF et l'email avant soumission
          if (REF) {
            setLS('rl_ref', REF);
            setCookie('rl_ref', REF, 180);
          }
          if (userEmail) {
            setLS('user_email', userEmail);
            setCookie('user_email', userEmail, 7);
          }

          // Afficher l'overlay
          overlay.style.display = 'flex';

          // PrÃ©parer les donnÃ©es
          const formData = new FormData(form);

          // Envoi vers Make.com
          fetch(form.action, {
            method: 'POST',
            body: formData
          })
            .then(function (response) {
              const locationHeader = response.headers.get('location');
              const isRedirectStatus = response.status >= 300 && response.status < 400;
              const contentType = (response.headers.get('content-type') || '').toLowerCase();
              const isJSON = contentType.includes('application/json');

              // Accepter les 3xx avec header Location
              if (!response.ok && !isRedirectStatus) {
                throw new Error('Erreur serveur: ' + response.status);
              }

              if (isJSON) {
                return response.json().catch(function () {
                  return { redirect: null };
                }).then(function (body) {
                  return { body: body, location: locationHeader, isText: false };
                });
              }

              // Texte brut (ex: URL de redirection dans le body)
              return response.text().catch(function () { return ''; }).then(function (txt) {
                return { body: txt, location: locationHeader, isText: true };
              });
            })
            .then(function (payload) {
              const locationHeader = payload.location;
              const isText = payload.isText;
              const body = payload.body || {};

              // PrioritÃ© : champ JSON redirect -> header Location -> body texte -> fallback local
              let nextUrl = (!isText && body.redirect) ? body.redirect
                : locationHeader
                    : isText ? (typeof body === 'string' ? body.trim() : '') : ''
                || 'page2-commercant.html';

              // Si le body est une URL relative ou absolue valide, on l'utilise
              if (!nextUrl) nextUrl = 'page2-commercant.html';

              const params = [];
              if (REF) params.push('ref=' + encodeURIComponent(REF));
              if (userEmail) params.push('email=' + encodeURIComponent(userEmail));
              if (params.length > 0) {
                const separator = nextUrl.includes('?') ? '&' : '?';
                nextUrl += separator + params.join('&');
              }

              console.log('âœ… Redirection vers:', nextUrl);
              console.log('âœ… Redirection vers:', nextUrl);
              setTimeout(function () {
                window.location.href = nextUrl;
              }, 800);
            })
            .catch(function (error) {
              console.error('âŒ Erreur lors de l''envoi:', error);
              overlay.style.display = 'none';
              setAlert('error', 'Une erreur est survenue lors de l''inscription. Veuillez rÃ©essayer.');
            });
        });
      }

      /* ====================================================
         MASQUAGE EN TEMPS RÃ‰EL
         ==================================================== */
      const prenomInput = document.querySelector('input[name="prenom"]');
      const nomInput = document.querySelector('input[name="nom"]');
      const commerceInput = document.querySelector('input[name="commerce"]');

      if (prenomInput) {
        prenomInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿'' -]/g, '');
        });
      }

      if (nomInput) {
        nomInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿'' -]/g, '');
        });
      }

      if (commerceInput) {
        commerceInput.addEventListener('input', function(e) {
          e.target.value = e.target.value.replace(/[^A-Za-z0-9Ã€-Ã–Ã˜-Ã¶Ã¸-Ã¿'' .,&-]/g, '');
        });
      }

      /* ====================================================
         AUTO-FORMATAGE DU CODE POSTAL
         ==================================================== */
      const codePostalInput = document.querySelector('input[name="code_postal"]');
      if (codePostalInput) {
        codePostalInput.addEventListener('input', function (e) {
          let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
          if (value.length > 6) value = value.substring(0, 6);

          // Ajouter l'espace aprÃ¨s le 3e caractÃ¨re (A1A 1A1)
          if (value.length > 3) {
            value = value.substring(0, 3) + ' ' + value.substring(3);
          }

          e.target.value = value;
        });
      }

      /* ====================================================
         SAUVEGARDE DU REF AVANT CHAQUE CLIC
         ==================================================== */
      document.addEventListener('click', function (e) {
        if (e.target.closest('button, [type="submit"], a')) {
          try {
            if (REF) {
              setLS('rl_ref', REF);
              setCookie('rl_ref', REF, 180);
            }
          } catch (err) { }
        }
      });

    })();
  </script>

  <!-- ================================================
     BANDEAU COOKIES RGPD
     ================================================ -->
  <script>
    (function () {
      const KEY = 'rlConsent';
      const STYLENAME = 'rlCookieStyle2025';
      const BARID = 'rlCookieBar';
      const MODALID = 'rlCookieModal';

      // Style
      if (!document.getElementById(STYLENAME)) {
        const css = .rl-cookie-bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #E3E8FF;
    box-shadow:0 -6px 24px rgba(0,0,0,.08);z-index:999999;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#1B2240}
    .rl-cookie-wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:16px;align-items:center}
    .rl-cookie-text{font-size:14px;line-height:1.5;flex:1}
    .rl-cookie-actions{display:flex;gap:8px}
    .rl-btn{border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
    .rl-btn-primary{background:#3E53A5;color:#fff}
    .rl-btn-ghost{background:#F5F8FF;color:#1B2240;border:1px solid #E3E8FF}
    .rl-cookie-link{color:#3E53A5;text-decoration:underline}
    .rl-cookie-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000000}
    .rl-cookie-card{background:#fff;border-radius:14px;width:min(680px,92vw);padding:22px;border:1px solid #E3E8FF}
    .rl-cookie-card h3{margin:0 0 10px;color:#3E53A5}
    .rl-row{display:flex;justify-content:space-between;align-items:center;border:1px solid #E3E8FF;border-radius:10px;padding:10px 12px;margin:8px 0}
    .rl-switch{position:relative;width:48px;height:26px;background:#E3E8FF;border-radius:999px;cursor:pointer}
    .rl-switch input{display:none}
    .rl-switch span{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2);transition:.2s}
    .rl-switch input:checked+span{left:25px;background:#3E53A5}
    @media(max-width:720px){.rl-cookie-wrap{flex-direction:column;align-items:flex-start}};
        const s = document.createElement('style');
        s.id = STYLENAME;
        s.textContent = css;
        document.head.appendChild(s);
      }

      // Si consentement dÃ©jÃ  enregistrÃ© â†’ ne rien afficher
      try {
        if (localStorage.getItem(KEY)) {
          return;
        }
      } catch (e) { }

      // HTML du bandeau
      const htmlBar = <div class="rl-cookie-wrap">
    <div class="rl-cookie-text">
      Nous utilisons des cookies pour assurer le bon fonctionnement du site et amÃ©liorer ton expÃ©rience.
      <a class="rl-cookie-link" href="politique-cookies.html">En savoir plus</a>.
    </div>
    <div class="rl-cookie-actions">
      <button class="rl-btn rl-btn-ghost" id="rlRefuse">Refuser</button>
      <button class="rl-btn rl-btn-ghost" id="rlPrefs">Personnaliser</button>
      <button class="rl-btn rl-btn-primary" id="rlAccept">Accepter</button>
    </div>
  </div>;

      const bar = document.createElement('div');
      bar.id = BARID;
      bar.className = 'rl-cookie-bar';
      bar.innerHTML = htmlBar;
      document.body.appendChild(bar);

      const modal = document.createElement('div');
      modal.id = MODALID;
      modal.className = 'rl-cookie-modal';
      modal.innerHTML = <div class="rl-cookie-card">
    <h3>PrÃ©fÃ©rences des cookies</h3>
    <div class="rl-row"><div><strong>NÃ©cessaires</strong> â€“ indispensables (toujours actifs)</div>
      <div class="rl-switch"><input type="checkbox" checked disabled><span></span></div></div>
    <div class="rl-row"><div><strong>Mesure d'audience</strong> (Analytics)</div>
      <label class="rl-switch"><input type="checkbox" id="cAnalytics"><span></span></label></div>
    <div class="rl-row"><div><strong>Fonctionnels</strong> (confort d'usage)</div>
      <label class="rl-switch"><input type="checkbox" id="cFunctional"><span></span></label></div>
    <div class="rl-row"><div><strong>Marketing</strong> (Meta, TikTok, YouTube)</div>
      <label class="rl-switch"><input type="checkbox" id="cMarketing"><span></span></label></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="rl-btn rl-btn-ghost" id="rlCancel">Annuler</button>
      <button class="rl-btn rl-btn-primary" id="rlSave">Enregistrer</button>
    </div>
  </div>;
      document.body.appendChild(modal);

      // Fonctions
      function hideNow() {
        const b = document.getElementById(BARID);
        const m = document.getElementById(MODALID);
        if (b) b.style.opacity = '0';
        setTimeout(() => {
          if (b) b.remove();
          if (m) m.remove();
        }, 300);
      }

      function saveConsent(obj) {
        try {
          localStorage.setItem(KEY, JSON.stringify(obj));
        } catch (e) { }
        hideNow();
      }

      // Ã‰coute des boutons
      function qs(id) {
        return document.getElementById(id);
      }

      qs('rlAccept').onclick = () => saveConsent({ analytics: true, functional: true, marketing: true });
      qs('rlRefuse').onclick = () => saveConsent({ analytics: false, functional: false, marketing: false });
      qs('rlPrefs').onclick = () => qs(MODALID).style.display = 'flex';
      qs('rlSave').onclick = () => {
        const c = {
          analytics: qs('cAnalytics').checked,
          functional: qs('cFunctional').checked,
          marketing: qs('cMarketing').checked
        };
        saveConsent(c);
      };
      qs('rlCancel').onclick = () => qs(MODALID).style.display = 'none';

    })();
  </script>

</body>

</html>
